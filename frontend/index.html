<html lang="ru" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTMka - сервис для бизнеса и маркетологов</title>

    <!-- Critical CSS - Hide unstyled content -->
    <style>
        html { visibility: hidden; opacity: 0; }
        html.fonts-loaded { visibility: visible; opacity: 1; transition: opacity 0.3s; }
        #app { opacity: 0; transition: opacity 0.4s; }
        #app.loaded { opacity: 1; }
    </style>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet"
        onload="document.documentElement.classList.add('fonts-loaded')">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" onerror="console.warn('Tailwind CDN failed to load')"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest" async defer onerror="console.warn('Lucide CDN failed to load')"></script>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css" onerror="console.warn('Flatpickr dark theme failed to load'); this.onerror=null;">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js" defer onerror="console.warn('Flatpickr ru locale failed to load'); this.onerror=null;"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            bg: '#0F172A',
                            card: '#1E293B',
                            border: '#334155'
                        },
                        brand: {
                            500: '#6366f1',
                            600: '#4f46e5',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="css/main.css">
</head>

<body
    class="bg-white dark:bg-[#0B1120] text-slate-800 dark:text-slate-200 font-sans h-full transition-colors duration-500 overflow-hidden selection:bg-indigo-500/30">

    <!-- Background Ambiance -->
    <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none opacity-30 dark:opacity-100">
        <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-indigo-500/20 rounded-full blur-[100px] animate-float delay-0"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-purple-500/20 rounded-full blur-[100px] animate-float delay-neg-2"></div>
        <div class="absolute top-[40%] left-[40%] w-[30%] h-[30%] bg-cyan-500/10 rounded-full blur-[80px] animate-float delay-neg-4"></div>
    </div>

    <div id="app" class="relative z-10 flex flex-col h-full">

        <!-- NAVBAR -->
        <nav id="navbar"
            class="hidden glass sticky top-4 mx-4 md:mx-6 lg:mx-8 rounded-2xl z-50 mb-6 transition-all duration-300">
            <div class="px-4 sm:px-6">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div
                            class="bg-white p-1 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex items-center justify-center">
                            <img src="logo/logoutm.png" alt="UTMka Logo" class="w-8 h-8 object-contain">
                        </div>
                        <span
                            class="font-display font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400">
                            UTMka
                        </span>
                    </div>

                    <!-- Desktop Nav -->
                    <div class="hidden md:flex items-center gap-1 bg-slate-200/50 dark:bg-slate-800/50 p-1 rounded-xl">
                        <a href="#generator"
                            class="nav-link px-4 py-1.5 rounded-lg text-sm font-medium transition-colors text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-white"
                            data-target="generator">Генератор</a>
                        <a href="#history"
                            class="nav-link px-4 py-1.5 rounded-lg text-sm font-medium transition-colors text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-white"
                            data-target="history">История</a>
                        <a href="#templates"
                            class="nav-link px-4 py-1.5 rounded-lg text-sm font-medium transition-colors text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-white"
                            data-target="templates">Шаблоны</a>
                        <a href="#help"
                            class="nav-link px-4 py-1.5 rounded-lg text-sm font-medium transition-colors text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-white"
                            data-target="help">Помощь</a>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-3">
                        <!-- Donate Button -->
                        <a href="#" id="donateNavLink" target="_blank" rel="noopener noreferrer"
                            class="p-2.5 rounded-full hover:bg-pink-100/50 dark:hover:bg-pink-900/30 transition-colors text-slate-400 hover:text-pink-500 dark:hover:text-slate-400 dark:hover:text-pink-400"
                            title="Поблагодарить">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                        </a>
                        <!-- Help Button -->
                        <button id="help-btn"
                            class="p-2.5 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors text-slate-500 dark:text-slate-400"
                            title="Помощь">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                        </button>
                        <!-- Language Toggle -->
                        <button id="lang-toggle"
                            class="px-3 py-1.5 rounded-full text-xs font-semibold border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60 transition-colors">
                            <span id="lang-toggle-label">RU</span>
                        </button>
                        <!-- Theme Toggle -->
                        <button id="theme-toggle" aria-label="Toggle theme"
                            class="p-2.5 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors text-slate-500 dark:text-slate-400">
                            <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Mobile Nav -->
            <div class="md:hidden flex border-t border-slate-200/50 dark:border-slate-700/50">
                <a href="#generator"
                    class="flex-1 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400"
                    data-target="generator">Генератор</a>
                <a href="#history"
                    class="flex-1 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400"
                    data-target="history">История</a>
                <a href="#templates"
                    class="flex-1 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400"
                    data-target="templates">Шаблоны</a>
                <a href="#help"
                    class="flex-1 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400"
                    data-target="help">Помощь</a>
            </div>
        </nav>

        <main class="flex-grow flex flex-col w-full h-full overflow-hidden">

            <!-- LOADER -->
            <div id="loader" class="flex flex-col items-center justify-center h-[80vh]">
                <div class="loader-spinner mb-4"></div>
                <p class="text-sm text-slate-500 font-medium animate-pulse">Загрузка системы...</p>
            </div>

            <div id="main-content"
                class="hidden w-full h-full flex flex-col gap-6 overflow-y-auto px-4 md:px-6 lg:px-8 py-4 pb-16 no-scrollbar">

                <!-- === GENERATOR VIEW === -->
                <div data-view="generator" class="active fade-in h-full flex flex-col">
                    <div class="flex flex-col lg:flex-row gap-6 h-full items-start">

                        <!-- Input Section -->
                        <div class="lg:w-[480px] flex-shrink-0">
                            <div class="glass-card p-6 md:p-8 rounded-3xl">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-600 dark:text-indigo-400">
                                        <i data-lucide="link" class="w-5 h-5"></i>
                                    </div>
                                    <h2 id="generatorTitle" class="text-xl font-display font-semibold">Параметры ссылки</h2>
                                </div>

                                <form id="utmForm" class="space-y-5">
                                    <!-- Base URL -->
                                    <div class="group">
                                        <label
                                            class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">URL
                                            адрес *</label>
                                        <div class="relative flex items-center">
                                            <div
                                                class="absolute left-0 top-0 bottom-0 px-3 flex items-center bg-slate-100 dark:bg-slate-800/50 border border-r-0 border-slate-200 dark:border-slate-700 rounded-l-xl text-slate-600 dark:text-slate-400 text-sm">
                                                https://
                                            </div>
                                            <input type="text" id="url" required placeholder="example.com/page"
                                                class="glass-input w-full pl-[5.5rem] pr-4 py-2.5 rounded-xl text-sm transition-all">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Источник</label>
                                            <input type="text" id="utm_source" placeholder="google, yandex"
                                                class="glass-input w-full px-4 py-2.5 rounded-xl text-sm transition-all">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Канал</label>
                                            <input type="text" id="utm_medium" placeholder="cpc, banner"
                                                class="glass-input w-full px-4 py-2.5 rounded-xl text-sm transition-all">
                                        </div>
                                    </div>

                                    <div class="space-y-4">
                                        <div>
                                            <label
                                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Кампания</label>
                                            <div class="relative">
                                                <input type="text" id="utm_campaign" placeholder="summer_sale"
                                                    class="glass-input w-full px-4 py-2.5 rounded-xl text-sm transition-all pr-10">
                                                <button type="button" aria-label="Select date"
                                                    class="date-picker-btn absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-slate-400 hover:text-indigo-500 transition-colors">
                                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Содержание</label>
                                            <div class="relative">
                                                <input type="text" id="utm_content" placeholder="link_bottom"
                                                    class="glass-input w-full px-4 py-2.5 rounded-xl text-sm transition-all pr-10">
                                                <button type="button" aria-label="Select date"
                                                    class="date-picker-btn absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-slate-400 hover:text-indigo-500 transition-colors">
                                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Ключевое
                                                слово</label>
                                            <div class="relative">
                                                <input type="text" id="utm_term" placeholder="running shoes"
                                                    class="glass-input w-full px-4 py-2.5 rounded-xl text-sm transition-all pr-10">
                                                <button type="button" aria-label="Select date"
                                                    class="date-picker-btn absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-slate-400 hover:text-indigo-500 transition-colors">
                                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex gap-3 pt-2">
                                        <button type="submit"
                                            class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-medium py-3 rounded-xl shadow-lg shadow-indigo-500/25 btn-hover-effect flex items-center justify-center gap-2">
                                            <i data-lucide="zap" class="w-4 h-4"></i>
                                            <span id="generateBtn">Создать UTM&#x2011;ссылку</span>
                                        </button>
                                        <button type="button" id="clearFormButton" title="Очистить форму"
                                            class="px-4 py-3 rounded-xl glass-input text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors font-medium flex items-center justify-center">
                                            <i data-lucide="eraser" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Result & Helper Section -->
                        <div class="flex-grow flex flex-col gap-6">
                            <!-- Result Card -->
                            <div class="glass-card p-6 rounded-3xl relative overflow-hidden">
                                <h3 id="resultTitle" class="text-sm font-semibold uppercase tracking-wider text-slate-500 mb-3">Результат
                                </h3>

                                <div class="relative group">
                                    <textarea id="resultUrl" readonly aria-label="Generated URL"
                                        class="w-full h-28 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-xl p-4 text-sm font-mono text-slate-800 dark:text-slate-300 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500/30 selection:bg-indigo-500/40"></textarea>
                                    <button id="copyButton" title="Копировать"
                                        class="absolute top-3 right-3 p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-100 dark:border-slate-700 text-slate-500 hover:text-indigo-600 transition-colors btn-hover-effect">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <div class="mt-4 flex flex-wrap gap-2">
                                    <button id="addToTemplateBtn" disabled
                                        class="flex-1 min-w-[140px] py-2.5 rounded-xl border border-dashed border-slate-300 dark:border-slate-600 text-slate-500 hover:text-indigo-600 hover:border-indigo-400 hover:bg-indigo-50/50 dark:hover:bg-indigo-900/10 transition-all font-medium text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                        <span id="saveAsTemplateBtn">Сохранить как шаблон</span>
                                    </button>
                                    <button id="shortenUrlButton" title="Сократить ссылку"
                                        class="px-4 py-2.5 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-500 hover:text-emerald-600 hover:border-emerald-400 hover:bg-emerald-50/50 dark:hover:bg-emerald-900/10 transition-all font-medium text-sm flex items-center justify-center gap-2">
                                        <i data-lucide="shrink" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Сократить</span>
                                    </button>
                                    <button id="qrCodeButton" title="QR-код"
                                        class="px-4 py-2.5 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-500 hover:text-purple-600 hover:border-purple-400 hover:bg-purple-50/50 dark:hover:bg-purple-900/10 transition-all font-medium text-sm flex items-center justify-center gap-2">
                                        <i data-lucide="qr-code" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">QR-код</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Templates Quick Access -->
                            <div class="glass-card flex-grow p-6 rounded-3xl flex flex-col justify-between">
                                <div>
                                    <h3 id="quickStartTitle"
                                        class="text-sm font-semibold uppercase tracking-wider text-slate-500 mb-4">
                                        Быстрый старт</h3>
                                    <div id="recentTemplatesContainer" class="flex flex-wrap gap-2">
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button id="showAllTemplatesBtn"
                                        class="text-xs font-medium text-indigo-600 hover:text-indigo-500 transition-colors">Открыть
                                        все</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === HISTORY VIEW === -->
                <div data-view="history" class="fade-in h-full flex flex-col">
                    <div class="glass-card p-6 md:p-8 rounded-3xl flex-grow flex flex-col min-h-0">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <h2 id="historyTitle" class="text-2xl font-display font-bold">История</h2>

                            <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
                                <div class="relative flex-grow md:flex-grow-0 md:w-64">
                                    <i data-lucide="search"
                                        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                    <input type="search" id="historySearch" placeholder="Поиск..." aria-label="Search history"
                                        class="glass-input pl-9 pr-4 py-2 rounded-xl text-sm w-full">
                                </div>
                                <input type="text" id="historyDateRange" placeholder="Дата" aria-label="Filter by date"
                                    class="glass-input px-3 py-2 rounded-xl text-sm w-32 text-center">

                                <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                    <button data-view-mode="list" aria-label="List view"
                                        class="history-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 hover:bg-white dark:hover:bg-slate-700 transition-all"><i
                                            data-lucide="list" class="w-4 h-4"></i></button>
                                    <button data-view-mode="grid" aria-label="Grid view"
                                        class="history-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 hover:bg-white dark:hover:bg-slate-700 transition-all"><i
                                            data-lucide="layout-grid" class="w-4 h-4"></i></button>
                                    <button data-view-mode="table" aria-label="Table view"
                                        class="history-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 hover:bg-white dark:hover:bg-slate-700 transition-all active"><i
                                            data-lucide="table" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                            <button id="importHistoryBtn"
                                class="px-4 py-2 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors whitespace-nowrap"><i
                                    data-lucide="upload" class="w-4 h-4"></i> Импорт</button>
                            <button id="exportHistoryJsonBtn"
                                class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors whitespace-nowrap border border-slate-200 dark:border-slate-700"><i
                                    data-lucide="file-json" class="w-4 h-4"></i> JSON</button>
                            <button id="exportHistoryCsvBtn"
                                class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors whitespace-nowrap border border-slate-200 dark:border-slate-700"><i
                                    data-lucide="file-spreadsheet" class="w-4 h-4"></i> CSV</button>
                            <input type="file" id="importHistoryFileInput" class="hidden" accept=".json,.csv" aria-label="Import history file">
                        </div>

                        <div id="historyContainer" class="w-full flex-grow overflow-y-auto px-1 pr-3 custom-scrollbar">
                        </div>
                    </div>
                </div>

                <!-- === TEMPLATES VIEW === -->
                <div data-view="templates" class="fade-in h-full flex flex-col">
                    <div class="flex flex-col xl:flex-row gap-6 h-full items-start">

                        <!-- Create Template Sidebar -->
                        <div class="xl:w-[400px] flex-shrink-0">
                            <div class="glass-card p-6 md:p-8 rounded-3xl sticky top-20">
                                <h2 id="newTemplateTitle" class="text-xl font-display font-bold mb-6">Новый шаблон</h2>
                                <form id="templateForm" class="space-y-4">
                                    <input type="hidden" id="template_id">
                                    <input type="text" id="template_name" required
                                        placeholder="Название шаблона (обязательно)"
                                        class="glass-input w-full px-4 py-2.5 rounded-xl text-sm font-medium">

                                    <div
                                        class="bg-indigo-50/50 dark:bg-indigo-900/10 p-4 rounded-xl space-y-3 border border-indigo-100 dark:border-indigo-500/10">
                                        <label id="templateTagLabel"
                                            class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider">Тег
                                            и Цвет</label>
                                        <input type="text" id="template_tag_name" placeholder="Название тега"
                                            class="glass-input w-full px-3 py-2 rounded-lg text-sm">
                                        <input type="hidden" id="template_tag_color">
                                        <div id="templateColorPalette" class="flex flex-wrap gap-2 pt-1"></div>
                                    </div>

                                    <div class="space-y-3 pt-2">
                                        <input type="text" id="template_utm_source" placeholder="utm_source"
                                            class="glass-input w-full px-4 py-2 rounded-xl text-sm">
                                        <input type="text" id="template_utm_medium" placeholder="utm_medium"
                                            class="glass-input w-full px-4 py-2 rounded-xl text-sm">
                                        <input type="text" id="template_utm_campaign" placeholder="utm_campaign"
                                            class="glass-input w-full px-4 py-2 rounded-xl text-sm">
                                        <input type="text" id="template_utm_content" placeholder="utm_content"
                                            class="glass-input w-full px-4 py-2 rounded-xl text-sm">
                                        <input type="text" id="template_utm_term" placeholder="utm_term"
                                            class="glass-input w-full px-4 py-2 rounded-xl text-sm">
                                    </div>

                                    <button type="submit"
                                        class="w-full mt-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-medium py-3 rounded-xl shadow-lg shadow-indigo-500/25 btn-hover-effect flex items-center justify-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Создать шаблон
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Templates List -->
                        <div class="flex-grow">
                            <div class="glass-card p-6 md:p-8 rounded-3xl flex-grow flex flex-col min-h-0">
                                <div
                                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                    <h2 id="templatesLibraryTitle" class="text-2xl font-display font-bold">Библиотека</h2>
                                    <div class="flex gap-2 items-center w-full sm:w-auto">
                                        <div class="relative flex-grow sm:flex-grow-0 sm:w-64">
                                            <i data-lucide="search"
                                                class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                            <input type="search" id="templatesSearch" placeholder="Поиск по шаблонам..."
                                                class="glass-input pl-9 pr-4 py-2 rounded-xl text-sm w-full">
                                        </div>
                                        <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                            <button data-view-mode="list"
                                                class="templates-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600"><i
                                                    data-lucide="list" class="w-4 h-4"></i></button>
                                            <button data-view-mode="grid"
                                                class="templates-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600"><i
                                                    data-lucide="layout-grid" class="w-4 h-4"></i></button>
                                            <button data-view-mode="table"
                                                class="templates-view-btn p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 active"><i
                                                    data-lucide="table" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-2 mb-6">
                                    <button id="importTemplatesBtn"
                                        class="px-4 py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"><i
                                            data-lucide="upload" class="w-4 h-4"></i> Импорт</button>
                                    <button id="exportJsonBtn"
                                        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><i
                                            data-lucide="file-json" class="w-4 h-4"></i> JSON</button>
                                    <button id="exportCsvBtn"
                                        class="px-4 py-2 bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-medium flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><i
                                            data-lucide="file-spreadsheet" class="w-4 h-4"></i> CSV</button>
                                    <input type="file" id="importFileInput" class="hidden" accept=".json,.csv" aria-label="Import templates file">
                                </div>

                                <div id="templatesContainer"
                                    class="flex-grow w-full overflow-y-auto px-1 pr-3 custom-scrollbar">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === HELP VIEW === -->
                <div data-view="help" class="fade-in h-full flex flex-col">
                    <div class="flex flex-col items-center justify-center min-h-[60vh] gap-6">
                        <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl">
                            <div class="p-6 border-b border-slate-200/50 dark:border-white/10">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-600 dark:text-indigo-400">
                                        <i data-lucide="help-circle" class="w-5 h-5"></i>
                                    </div>
                                    <h3 id="helpViewTitle" class="text-xl font-bold text-slate-900 dark:text-white">Помощь</h3>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <button id="openOnboardingFromHelp"
                                    class="w-full px-4 py-3 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors flex items-center justify-center gap-2 font-medium">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    <span id="helpOnboardingBtn">Пройти обучение</span>
                                </button>
                                <a href="#" id="donateHelpLink" target="_blank" rel="noopener noreferrer"
                                    class="w-full px-4 py-3 rounded-xl bg-pink-50 dark:bg-pink-900/20 text-pink-600 dark:text-pink-400 hover:bg-pink-100 dark:hover:bg-pink-900/30 transition-colors flex items-center justify-center gap-2 font-medium">
                                    <i data-lucide="heart" class="w-5 h-5"></i>
                                    <span id="helpDonateBtn">Поддержать проект</span>
                                </a>
                                <div class="space-y-2">
                                    <a href="https://t.me/pronin_marketing" target="_blank" rel="noopener noreferrer"
                                        class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2 font-medium border border-slate-200 dark:border-slate-700">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                        <span id="helpTelegramBtn">Telegram канал</span>
                                    </a>
                                    <a href="https://alex-pronin.ru/projects/utmka" target="_blank" rel="noopener noreferrer"
                                        class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2 font-medium border border-slate-200 dark:border-slate-700">
                                        <i data-lucide="globe" class="w-5 h-5"></i>
                                        <span id="helpWebsiteBtn">Сайт проекта</span>
                                    </a>
                                    <a href="https://github.com/Goryuchnick/utmKA-2.0/issues" target="_blank" rel="noopener noreferrer"
                                        class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center gap-2 font-medium border border-slate-200 dark:border-slate-700">
                                        <i data-lucide="github" class="w-5 h-5"></i>
                                        <span id="helpGithubBtn">GitHub Issues</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- FOOTER -->
            <footer class="mt-auto py-2 px-4 md:px-6 lg:px-8 glass border-t border-slate-200/50 dark:border-slate-700/50 z-30">
                <div class="w-full flex justify-between items-center text-xs text-slate-500 dark:text-slate-400">
                    <div class="flex items-center gap-4">
                        <span>Подпишись на полезное</span>
                        <span class="hidden sm:inline text-slate-300 dark:text-slate-700">|</span>
                        <a href="https://t.me/pronin_marketing" target="_blank" rel="noopener noreferrer"
                            class="hover:text-indigo-500 transition-colors flex items-center gap-1">
                            <i data-lucide="send" class="w-3 h-3"></i> Telegram
                        </a>
                        <span class="hidden sm:inline text-slate-300 dark:text-slate-700">|</span>
                        <a href="#" id="donateFooterLink" target="_blank" rel="noopener noreferrer"
                            class="hover:text-pink-500 transition-colors flex items-center gap-1">
                            <i data-lucide="heart" class="w-3 h-3"></i> <span id="donateFooterText">Поблагодарить</span>
                        </a>
                    </div>
                    <a href="https://alex-pronin.ru" target="_blank" rel="noopener noreferrer"
                        class="px-2 py-1 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded hover:bg-indigo-100 transition-colors">alex-pronin.ru</a>
                </div>
            </footer>
        </main>

        <!-- ONBOARDING OVERLAY -->
        <div id="onboardingOverlay" class="fixed inset-0 hidden z-[150]">
            <!-- Затемняющий слой с вырезкой (clip-path управляется из JS) -->
            <div id="onboardingMask" class="absolute inset-0 bg-black/50"></div>

            <!-- Рамка подсветки целевого элемента -->
            <div id="onboardingHighlight"
                class="absolute border-2 border-indigo-400 rounded-xl pointer-events-none z-10"
                style="box-shadow: 0 0 0 4px rgba(99,102,241,0.25); display: none;"></div>

            <!-- Карточка тура (позиционируется JS'ом) -->
            <div id="onboardingCard"
                class="absolute z-20 w-full max-w-md rounded-2xl shadow-2xl border border-slate-200/50 dark:border-white/10 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl"
                style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
                <div class="p-5 border-b border-slate-200/50 dark:border-white/10 flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-2xl bg-indigo-500/10 text-indigo-600 dark:text-indigo-300 flex items-center justify-center">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h2 id="onboardingTitle"
                                class="text-lg font-semibold text-slate-900 dark:text-white">
                                Добро пожаловать в UTMka</h2>
                            <p id="onboardingStepIndicator" class="text-xs text-slate-500 mt-0.5">1 / 5</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="onboardingLangToggle"
                            class="px-3 py-1.5 rounded-full text-xs font-semibold border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60 transition-colors">
                            <span id="onboardingLangLabel">RU</span>
                        </button>
                        <button id="onboardingSkip"
                            class="text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white transition-colors">
                            Пропустить
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <p id="onboardingText" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
                        Это короткий тур по приложению: генератор UTM-ссылок, история и библиотека шаблонов.
                    </p>
                    <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                        <li class="flex gap-2">
                            <span class="mt-1 w-1.5 h-1.5 rounded-full bg-indigo-500 shrink-0"></span>
                            <span id="onboardingBullet1">Создавайте чистые UTM-ссылки и копируйте их одним кликом.</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="mt-1 w-1.5 h-1.5 rounded-full bg-indigo-500 shrink-0"></span>
                            <span id="onboardingBullet2">Сохраняйте историю и шаблоны локально без аккаунта и оплат.</span>
                        </li>
                    </ul>
                </div>
                <div class="px-5 pb-4 pt-3 flex items-center justify-between gap-3 border-t border-slate-200/50 dark:border-white/10">
                    <button id="onboardingBack"
                        class="px-3 py-2 text-xs md:text-sm rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                        Назад
                    </button>
                    <div class="flex gap-2">
                        <button id="onboardingDone"
                            class="hidden px-4 py-2 rounded-lg bg-slate-900 text-white text-xs md:text-sm font-medium hover:bg-slate-800 dark:bg-indigo-600 dark:hover:bg-indigo-500 shadow-lg shadow-slate-900/20 dark:shadow-indigo-500/20 transition-colors">
                            Готово
                        </button>
                        <button id="onboardingNext"
                            class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-xs md:text-sm font-medium hover:bg-indigo-500 shadow-lg shadow-indigo-500/20 transition-colors flex items-center gap-2">
                            <span>Далее</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- URL Detail Modal -->
    <div id="urlDetailModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="glass-card w-full max-w-2xl rounded-2xl overflow-hidden shadow-2xl animate-fade-in">
            <div class="p-6 border-b border-slate-200/50 dark:border-white/10">
                <h3 class="text-xl font-bold dark:text-white">Детали ссылки</h3>
            </div>
            <div class="p-6">
                <textarea id="fullUrlText" readonly aria-label="Full URL"
                    class="w-full text-sm font-mono p-4 rounded-xl bg-slate-50 dark:bg-[#0B1120] border border-slate-200 dark:border-white/10 h-32 resize-y focus:ring-2 focus:ring-indigo-500/50 outline-none"></textarea>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-[#0B1120]/50 flex flex-wrap justify-between gap-3 rounded-b-lg">
                <button id="closeUrlDetailModal"
                    class="px-4 py-2 border border-slate-200 dark:border-white/10 rounded-lg text-sm hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Закрыть</button>
                <div class="flex flex-wrap gap-2">
                    <button id="deleteUrlBtn"
                        class="px-4 py-2 bg-red-500/10 text-red-600 hover:bg-red-500/20 rounded-lg text-sm font-medium transition-colors">Удалить</button>
                    <button id="shortenUrlModalBtn"
                        class="px-4 py-2 bg-emerald-500/10 text-emerald-600 hover:bg-emerald-500/20 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5">
                        <i data-lucide="shrink" class="w-4 h-4"></i>
                        <span id="shortenUrlModalBtnText">Сократить</span>
                    </button>
                    <button id="qrCodeModalBtn"
                        class="px-4 py-2 bg-purple-500/10 text-purple-600 hover:bg-purple-500/20 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5">
                        <i data-lucide="qr-code" class="w-4 h-4"></i>
                        <span id="qrCodeModalBtnText">QR-код</span>
                    </button>
                    <button id="copyFullUrlBtn"
                        class="px-4 py-2 bg-indigo-500/10 text-indigo-600 hover:bg-indigo-500/20 rounded-lg text-sm font-medium transition-colors">Копировать</button>
                    <button id="applyFromModalBtn"
                        class="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500 rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 transition-colors">Использовать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Templates Modal -->
    <div id="allTemplatesModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="glass-card w-full max-w-xl max-h-[85vh] flex flex-col rounded-2xl shadow-2xl animate-fade-in">
            <div class="p-5 border-b border-slate-200/50 dark:border-white/10">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Все шаблоны</h3>
            </div>
            <div class="p-4">
                <input type="search" id="modalTemplateSearch" placeholder="Поиск..." aria-label="Search templates"
                    class="glass-input w-full px-4 py-2 rounded-xl text-sm">
            </div>
            <div id="modalTemplatesList" class="flex-grow overflow-y-auto px-4 pb-4 space-y-2 custom-scrollbar">
            </div>
            <div class="p-4 border-t border-slate-200/50 dark:border-white/10 text-right">
                <button id="closeModalBtn"
                    class="px-4 py-2 border border-slate-200 dark:border-white/10 rounded-lg text-sm hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Save Template Modal -->
    <div id="saveTemplateModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl animate-fade-in">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4">Сохранить как шаблон</h3>
                <div class="space-y-4">
                    <input type="text" id="newTemplateNameInput" placeholder="Название шаблона *" required aria-label="Template Name"
                        class="glass-input w-full px-4 py-2.5 rounded-xl text-sm">

                    <div class="bg-indigo-50/50 dark:bg-indigo-900/10 p-3 rounded-xl">
                        <input type="text" id="newTemplateTagNameInput" placeholder="Тег (опционально)" aria-label="Tag Name"
                            class="glass-input w-full px-3 py-2 rounded-lg text-sm mb-2">
                        <input type="hidden" id="newTemplateTagColorInput">
                        <div id="newTemplateColorPalette" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50/50 dark:bg-[#0B1120]/50 flex justify-end gap-3">
                <button id="cancelSaveTemplate"
                    class="px-4 py-2 rounded-lg text-sm border border-slate-200 dark:border-white/10 hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Отмена</button>
                <button id="confirmSaveTemplate"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 hover:bg-indigo-500 transition-colors">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importTemplatesModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl animate-fade-in">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4 text-indigo-600 dark:text-indigo-400">
                    <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Импорт</h3>
                </div>
                <p class="text-sm text-slate-500 mb-6">Поддерживаются JSON и CSV файлы. Выберите файл для загрузки ваших
                    шаблонов.</p>

                <div class="flex gap-4 mb-6">
                    <button id="downloadJsonTemplate"
                        class="text-xs text-indigo-500 hover:text-indigo-400 hover:underline">Скачать пример
                        JSON</button>
                    <button id="downloadCsvTemplate"
                        class="text-xs text-indigo-500 hover:text-indigo-400 hover:underline">Скачать пример
                        CSV</button>
                </div>

                <div class="flex justify-end gap-3">
                    <button id="closeImportModal"
                        class="px-4 py-2 rounded-lg text-sm border border-slate-200 dark:border-white/10 hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Отмена</button>
                    <button id="triggerImportFile"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 hover:bg-indigo-500 transition-colors">Выбрать
                        файл</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Detail Modal -->
    <div id="templateDetailModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
        <div class="glass-card w-full max-w-lg rounded-2xl shadow-2xl animate-fade-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="templateDetailName" class="text-xl font-bold truncate pr-4"></h3>
                    <div id="templateDetailTag" class="flex-shrink-0"></div>
                </div>
                <div class="space-y-3 text-sm bg-slate-50 dark:bg-black/20 p-4 rounded-xl border border-slate-200 dark:border-white/5">
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span
                            class="text-slate-500 font-medium">Source:</span> <span id="templateDetailSource"
                            class="font-mono text-indigo-600 dark:text-indigo-400 truncate"></span></div>
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span
                            class="text-slate-500 font-medium">Medium:</span> <span id="templateDetailMedium"
                            class="font-mono text-indigo-600 dark:text-indigo-400 truncate"></span></div>
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span
                            class="text-slate-500 font-medium">Campaign:</span> <span id="templateDetailCampaign"
                            class="font-mono text-slate-700 dark:text-slate-300 truncate"></span></div>
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span
                            class="text-slate-500 font-medium">Content:</span> <span id="templateDetailContent"
                            class="font-mono text-slate-700 dark:text-slate-300 truncate"></span></div>
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span
                            class="text-slate-500 font-medium">Term:</span> <span id="templateDetailTerm"
                            class="font-mono text-slate-700 dark:text-slate-300 truncate"></span></div>
                    <div class="h-px bg-slate-200 dark:bg-white/10 my-2"></div>
                    <div class="grid grid-cols-[100px_1fr] gap-2 items-center"><span id="templateDetailCreatedLabel"
                            class="text-slate-500 font-medium">Создан:</span> <span id="templateDetailCreated"
                            class="text-slate-400"></span></div>
                </div>
            </div>
            <div class="p-4 bg-slate-50/50 dark:bg-[#0B1120]/50 flex justify-end gap-3">
                <button id="closeTemplateDetailModal"
                    class="px-4 py-2 border border-slate-200 dark:border-white/10 rounded-lg text-sm hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Закрыть</button>
                <button id="applyTemplateBtn"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 hover:bg-indigo-500 transition-colors">Применить</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-6 z-[200] transform transition-all duration-300 translate-x-[150%]">
        <div class="glass flex items-center gap-3 px-4 py-3 rounded-xl border-l-4 border-green-500 shadow-2xl">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <p id="toast-message" class="text-sm font-medium pr-2"></p>
        </div>
    </div>

    <!-- Modular JavaScript (ES6 modules) -->
    <script type="module" src="js/app.js"></script>
</body>

</html>
